# 任务状态和自动刷新功能说明

## 新增功能

### 1. 任务状态跟踪
后端现在会跟踪所有采集任务的执行状态：
- 是否正在运行
- 当前任务类型（手动/定时）
- 执行进度信息
- 最后更新时间

### 2. 自动刷新机制
前端会自动检测任务完成并刷新数据：
- 手动采集任务：每3秒检查一次状态，最多2分钟
- 定时任务：同样自动检测并刷新
- 任务完成后自动更新仪表盘

### 3. 进度提示
- 启动任务时显示进度提示
- 任务执行中显示加载动画
- 任务完成后自动刷新页面

## 后端改进

### 任务状态 API
```
GET /api/task-status
```

返回：
```json
{
  "is_running": true,
  "current_task": "manual_DeepSeek",
  "last_update": 1737043200,
  "progress": "正在采集数据: DeepSeek"
}
```

### 详细日志
后端现在输出详细的执行日志：
```
INFO:__main__:🔍 检查定时任务...
INFO:__main__:找到 1 个待执行任务
INFO:__main__:检查订阅 #1: 测试关键词, next_run=1737043200, now=1737043205
INFO:__main__:  ✓ 触发任务执行: 测试关键词
INFO:__main__:Running scheduled task for subscription 1
INFO:__main__:Scheduled Collection: 测试关键词
INFO:__main__:Scheduled Analysis
INFO:__main__:✓ 定时任务完成: 测试关键词
```

## 前端改进

### 自动轮询
- 启动采集任务后，前端自动每3秒检查一次任务状态
- 检测到任务完成后，自动刷新仪表盘数据
- 无需手动刷新页面

### 进度提示
- 点击"开始采集与分析"按钮后显示进度提示
- 显示加载动画和提示文字
- 任务完成后自动消失

## 测试方法

### 方法1：使用完整工作流程测试
```bash
python test_full_workflow.py
```

这个脚本会：
1. 创建1分钟间隔的测试订阅
2. 等待任务执行
3. 检查数据更新
4. 检查报警
5. 清理测试数据

### 方法2：前端测试
1. 在仪表盘创建采集任务
2. 观察进度提示
3. 等待任务完成（会自动刷新）
4. 查看更新后的数据

### 方法3：定时任务测试
1. 创建1分钟间隔的订阅
2. 等待1-2分钟
3. 查看后端日志确认任务执行
4. 刷新前端查看数据更新

## 故障排查

### 任务没有执行
1. 检查后端日志：
   ```
   INFO:__main__:🔍 检查定时任务...
   INFO:__main__:找到 0 个待执行任务
   ```
   如果找到0个任务，说明 `next_run` 时间还没到

2. 检查订阅的 `next_run` 时间：
   ```sql
   SELECT id, keyword, next_run, datetime(next_run, 'unixepoch', 'localtime') 
   FROM subscriptions;
   ```

3. 确认调度器正在运行：
   ```
   INFO:apscheduler.scheduler:Scheduler started
   INFO:apscheduler.executors.default:Running job "check_subscriptions"
   ```

### 前端没有自动刷新
1. 打开浏览器开发者工具查看网络请求
2. 确认是否有 `/api/task-status` 请求
3. 检查任务状态返回值

### 数据没有更新
1. 检查 `analysis_report.json` 是否存在
2. 检查数据库 `cleaned_data` 表是否有数据
3. 查看后端日志是否有错误

## 性能优化建议

1. **轮询间隔**：默认3秒，可以根据需要调整
2. **最大轮询次数**：默认40次（2分钟），可以根据任务耗时调整
3. **定时检查间隔**：默认1分钟，不建议设置太短

## 注意事项

1. 任务执行时间取决于：
   - 采集的数据量
   - AI 分析的复杂度
   - 网络速度
   - 服务器性能

2. 建议的间隔时间：
   - 测试：1-2分钟
   - 开发：5-10分钟
   - 生产：6小时或更长

3. 负面舆情报警：
   - 情感得分 < 30 时自动创建报警
   - 报警会显示在仪表盘右上角
   - 点击通知图标查看详情
