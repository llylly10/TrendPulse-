# 定时任务使用指南

## 功能说明

定时任务允许系统自动定期采集和分析指定关键词的舆情数据，并在检测到负面舆情时自动报警。

## 时间间隔设置

现在支持灵活的时间间隔设置，可以精确到秒：

- **时（小时）**：0-23
- **分（分钟）**：0-59
- **秒（秒）**：0-59

**示例：**
- `0时 1分 0秒` = 每分钟执行一次（测试用）
- `0时 5分 0秒` = 每5分钟执行一次
- `0时 30分 0秒` = 每30分钟执行一次
- `1时 0分 0秒` = 每小时执行一次
- `6时 0分 0秒` = 每6小时执行一次（默认）

**最小间隔：** 10秒（防止频繁请求）

## 使用步骤

### 1. 创建定时任务

1. 进入"定时任务"页面
2. 点击右上角的 `+` 按钮
3. 填写表单：
   - **关键词**：要监控的关键词（必填）
   - **语言**：选择中文或英文
   - **执行间隔**：设置时、分、秒
   - **采集数量**：设置各平台的采集条数
4. 点击"创建"

### 2. 查看任务状态

在订阅列表中可以看到：
- 关键词
- 执行间隔（自动格式化显示）
- 下次运行时间

### 3. 自动报警

当检测到负面舆情（情感得分 < 30）时，系统会：
- 自动创建报警记录
- 在仪表盘右上角显示通知图标
- 点击通知图标可查看详情

### 4. 删除任务

点击任务卡片右侧的删除图标，确认后即可删除。

## 测试定时任务

### 方法1：使用测试脚本

```bash
python test_scheduler.py
```

这个脚本会：
1. 创建一个30秒间隔的测试订阅
2. 监控任务执行状态
3. 按 Ctrl+C 停止并清理测试数据

### 方法2：前端测试

1. 创建一个1分钟间隔的订阅（0时 1分 0秒）
2. 等待1-2分钟
3. 查看仪表盘是否有新数据
4. 查看通知是否有报警

### 方法3：查看后端日志

后端会输出定时任务的执行日志：
```
INFO:__main__:Running scheduled task for subscription 1
```

## 工作原理

1. **调度器**：后端使用 APScheduler 每分钟检查一次
2. **任务触发**：当 `next_run <= 当前时间` 时触发任务
3. **执行流程**：
   - 采集数据（Reddit、YouTube、Twitter）
   - 清洗数据
   - AI 分析
   - 检查情感得分
   - 如果 < 30，创建报警
   - 更新 `next_run` 时间
4. **防重入**：避免同一任务重复执行

## 注意事项

1. **最小间隔**：建议不要设置太短的间隔（< 5分钟），避免频繁请求
2. **API 限制**：各平台可能有请求频率限制
3. **资源消耗**：AI 分析需要时间和资源，间隔太短可能导致任务积压
4. **测试建议**：测试时可以设置1-2分钟的间隔，正式使用建议6小时以上

## 故障排查

### 任务没有执行

1. 检查后端是否运行：`http://localhost:8000/docs`
2. 查看后端日志是否有错误
3. 检查 `next_run` 时间是否正确
4. 确认调度器是否启动（日志中应该有 "Scheduler started"）

### 没有收到报警

1. 检查情感得分是否 < 30
2. 查看数据库 `alerts` 表是否有记录
3. 刷新前端页面

### 时间显示不正确

1. 检查系统时区设置
2. 确认数据库中的时间戳是否正确（Unix 时间戳）
